const { query, testConnection } = require('../config/database');
const bcrypt = require('bcryptjs');

async function seed() {
  try {
    console.log('ğŸŒ± å¼€å§‹æ•°æ®åº“ç§å­æ•°æ®...');
    
    await testConnection();
    
    // æ¸…ç©ºç°æœ‰æ•°æ®ï¼ˆå¯é€‰ï¼‰
    console.log('ğŸ—‘ï¸ æ¸…ç†ç°æœ‰æ•°æ®...');
    
    // æ’å…¥ç§‘ç›®æ•°æ®
    console.log('ğŸ“š æ’å…¥ç§‘ç›®æ•°æ®...');
    await query(`
      INSERT IGNORE INTO sl_subjects (code, name, display_name, description, icon_class, color, sort_order, is_active) VALUES
      ('math', 'mathematics', 'æ•°å­¦', 'é«˜ä¸­æ•°å­¦å…¨é¢å­¦ä¹ ï¼ŒåŒ…å«å‡½æ•°ã€å‡ ä½•ã€æ¦‚ç‡ç»Ÿè®¡ç­‰', 'el-icon-calculator', '#409EFF', 1, true),
      ('physics', 'physics', 'ç‰©ç†', 'é«˜ä¸­ç‰©ç†å­¦ä¹ ï¼Œæ¶µç›–åŠ›å­¦ã€ç”µå­¦ã€å…‰å­¦ç­‰', 'el-icon-lightning', '#67C23A', 2, false),
      ('chemistry', 'chemistry', 'åŒ–å­¦', 'é«˜ä¸­åŒ–å­¦å­¦ä¹ ï¼ŒåŒ…å«æ— æœºã€æœ‰æœºã€ç‰©ç†åŒ–å­¦', 'el-icon-test-tube', '#E6A23C', 3, false),
      ('biology', 'biology', 'ç”Ÿç‰©', 'é«˜ä¸­ç”Ÿç‰©å­¦ä¹ ï¼Œæ¶µç›–ç»†èƒã€é—ä¼ ã€ç”Ÿæ€ç­‰', 'el-icon-grape', '#F56C6C', 4, false)
    `);
    
    // æ’å…¥æ•°å­¦æ•™ææ•°æ®
    console.log('ğŸ“– æ’å…¥æ•™ææ•°æ®...');
    await query(`
      INSERT IGNORE INTO sl_textbooks (subject_id, name, version, publisher, grade, description, is_active, sort_order) VALUES
      (1, 'æ™®é€šé«˜ä¸­æ•™ç§‘ä¹¦æ•°å­¦', 'äººæ•™ç‰ˆAç‰ˆ', 'äººæ°‘æ•™è‚²å‡ºç‰ˆç¤¾', 'é«˜ä¸€', 'äººæ•™ç‰ˆAç‰ˆé«˜ä¸€æ•°å­¦æ•™æ', true, 1),
      (1, 'æ™®é€šé«˜ä¸­æ•™ç§‘ä¹¦æ•°å­¦', 'äººæ•™ç‰ˆAç‰ˆ', 'äººæ°‘æ•™è‚²å‡ºç‰ˆç¤¾', 'é«˜äºŒ', 'äººæ•™ç‰ˆAç‰ˆé«˜äºŒæ•°å­¦æ•™æ', true, 2),
      (1, 'æ™®é€šé«˜ä¸­æ•™ç§‘ä¹¦æ•°å­¦', 'äººæ•™ç‰ˆAç‰ˆ', 'äººæ°‘æ•™è‚²å‡ºç‰ˆç¤¾', 'é«˜ä¸‰', 'äººæ•™ç‰ˆAç‰ˆé«˜ä¸‰æ•°å­¦æ•™æ', true, 3)
    `);
    
    // æ’å…¥æ•°å­¦ç« èŠ‚æ•°æ®
    console.log('ğŸ“„ æ’å…¥ç« èŠ‚æ•°æ®...');
    await query(`
      INSERT IGNORE INTO sl_chapters (id, subject_id, textbook_id, chapter_number, title, description, difficulty_level, sort_order) VALUES
      (1, 1, 1, '1', 'é›†åˆä¸é€»è¾‘', 'é›†åˆçš„æ¦‚å¿µã€è¿ç®—åŠé€»è¾‘æ¨ç†', 1, 1),
      (2, 1, 1, '2', 'å‡½æ•°åŸºç¡€', 'å‡½æ•°çš„æ¦‚å¿µã€æ€§è´¨åŠåŸºæœ¬å‡½æ•°', 2, 2),
      (3, 1, 1, '3', 'æŒ‡æ•°å¯¹æ•°å‡½æ•°', 'æŒ‡æ•°å‡½æ•°ã€å¯¹æ•°å‡½æ•°çš„å›¾åƒä¸æ€§è´¨', 3, 3),
      (4, 1, 1, '4', 'ä¸‰è§’å‡½æ•°', 'ä¸‰è§’å‡½æ•°å®šä¹‰ã€å›¾åƒã€æ’ç­‰å˜æ¢', 3, 4),
      (5, 1, 1, '5', 'å¹³é¢å‘é‡', 'å‘é‡çš„æ¦‚å¿µã€è¿ç®—åŠåº”ç”¨', 2, 5)
    `);
    
    // æ’å…¥çŸ¥è¯†ç‚¹æ•°æ®
    console.log('ğŸ§  æ’å…¥çŸ¥è¯†ç‚¹æ•°æ®...');
    const knowledgePoints = [
      // é«˜ä¸€ä¸Šå­¦æœŸï¼šé›†åˆä¸é€»è¾‘
      [1, 'MATH_G1_S1_SET_01', 'é›†åˆçš„æ¦‚å¿µ', null, 1, 'é«˜ä¸€', 'ä¸Šå­¦æœŸ', true, 0.95, 1, 'é›†åˆçš„å®šä¹‰ã€è¡¨ç¤ºæ–¹æ³•ã€å…ƒç´ ä¸é›†åˆçš„å…³ç³»', '["é›†åˆ", "å…ƒç´ ", "å±äºå…³ç³»"]', '[]', 'ç†è§£é›†åˆçš„æ¦‚å¿µï¼ŒæŒæ¡é›†åˆçš„è¡¨ç¤ºæ–¹æ³•'],
      [1, 'MATH_G1_S1_SET_02', 'é›†åˆçš„è¿ç®—', null, 1, 'é«˜ä¸€', 'ä¸Šå­¦æœŸ', true, 0.90, 2, 'é›†åˆçš„äº¤é›†ã€å¹¶é›†ã€è¡¥é›†è¿ç®—', '["äº¤é›†", "å¹¶é›†", "è¡¥é›†"]', '[1]', 'æŒæ¡é›†åˆçš„åŸºæœ¬è¿ç®—åŠå…¶æ€§è´¨'],
      [1, 'MATH_G1_S1_LOGIC_01', 'å‘½é¢˜ä¸é‡è¯', null, 1, 'é«˜ä¸€', 'ä¸Šå­¦æœŸ', true, 0.85, 2, 'å‘½é¢˜çš„æ¦‚å¿µã€å…¨ç§°é‡è¯ä¸å­˜åœ¨é‡è¯', '["å‘½é¢˜", "å…¨ç§°é‡è¯", "å­˜åœ¨é‡è¯"]', '[1,2]', 'ç†è§£å‘½é¢˜çš„æ¦‚å¿µï¼ŒæŒæ¡é‡è¯çš„ä½¿ç”¨'],
      [1, 'MATH_G1_S1_LOGIC_02', 'å……åˆ†å¿…è¦æ¡ä»¶', null, 1, 'é«˜ä¸€', 'ä¸Šå­¦æœŸ', true, 0.88, 3, 'å……åˆ†æ¡ä»¶ã€å¿…è¦æ¡ä»¶ã€å……è¦æ¡ä»¶çš„åˆ¤æ–­', '["å……åˆ†æ¡ä»¶", "å¿…è¦æ¡ä»¶", "å……è¦æ¡ä»¶"]', '[3]', 'æŒæ¡å……åˆ†å¿…è¦æ¡ä»¶çš„åˆ¤æ–­æ–¹æ³•'],
      
      // é«˜ä¸€ä¸Šå­¦æœŸï¼šå‡½æ•°åŸºç¡€
      [1, 'MATH_G1_S1_FUNC_01', 'å‡½æ•°çš„æ¦‚å¿µ', null, 2, 'é«˜ä¸€', 'ä¸Šå­¦æœŸ', true, 0.95, 2, 'å‡½æ•°çš„å®šä¹‰ã€å®šä¹‰åŸŸã€å€¼åŸŸ', '["å‡½æ•°", "å®šä¹‰åŸŸ", "å€¼åŸŸ"]', '[1,2]', 'ç†è§£å‡½æ•°çš„æ¦‚å¿µï¼ŒæŒæ¡å‡½æ•°çš„è¡¨ç¤ºæ–¹æ³•'],
      [1, 'MATH_G1_S1_FUNC_02', 'å‡½æ•°çš„æ€§è´¨', null, 2, 'é«˜ä¸€', 'ä¸Šå­¦æœŸ', true, 0.92, 3, 'å‡½æ•°çš„å•è°ƒæ€§ã€å¥‡å¶æ€§ã€å‘¨æœŸæ€§', '["å•è°ƒæ€§", "å¥‡å¶æ€§", "å‘¨æœŸæ€§"]', '[5]', 'æŒæ¡å‡½æ•°çš„åŸºæœ¬æ€§è´¨åŠå…¶åº”ç”¨'],
      [1, 'MATH_G1_S1_FUNC_03', 'äºŒæ¬¡å‡½æ•°', null, 2, 'é«˜ä¸€', 'ä¸Šå­¦æœŸ', true, 0.98, 3, 'äºŒæ¬¡å‡½æ•°çš„å›¾åƒä¸æ€§è´¨', '["æŠ›ç‰©çº¿", "å¯¹ç§°è½´", "æœ€å€¼"]', '[5,6]', 'æŒæ¡äºŒæ¬¡å‡½æ•°çš„å›¾åƒå’Œæ€§è´¨'],
      [1, 'MATH_G1_S1_FUNC_04', 'å¹‚å‡½æ•°', null, 2, 'é«˜ä¸€', 'ä¸Šå­¦æœŸ', true, 0.80, 2, 'å¹‚å‡½æ•°çš„å®šä¹‰ã€å›¾åƒä¸æ€§è´¨', '["å¹‚å‡½æ•°", "æŒ‡æ•°", "å›¾åƒç‰¹å¾"]', '[6]', 'äº†è§£å¹‚å‡½æ•°çš„åŸºæœ¬æ€§è´¨']
    ];
    
    for (const kp of knowledgePoints) {
      await query(`
        INSERT IGNORE INTO sl_knowledge_points 
        (subject_id, code, name, parent_id, chapter_id, grade, semester, is_core, exam_frequency, difficulty_level, description, key_concepts, prerequisites, learning_objectives) 
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
      `, kp);
    }
    
    // åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
    console.log('ğŸ‘¤ åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·...');
    const hashedPassword = await bcrypt.hash('admin123', 10);
    await query(`
      INSERT IGNORE INTO sl_users (username, email, password_hash, real_name, nickname, role, grade, status) VALUES
      ('admin', 'admin@smartlearn.com', ?, 'ç³»ç»Ÿç®¡ç†å‘˜', 'ç®¡ç†å‘˜', 'admin', 'é«˜ä¸€', 'active'),
      ('teacher', 'teacher@smartlearn.com', ?, 'å¼ è€å¸ˆ', 'æ•°å­¦è€å¸ˆ', 'teacher', 'é«˜ä¸€', 'active'),
      ('student', 'student@smartlearn.com', ?, 'æåŒå­¦', 'å°æ', 'student', 'é«˜ä¸€', 'active')
    `, [hashedPassword, hashedPassword, hashedPassword]);
    
    // æ’å…¥ç¤ºä¾‹é¢˜ç›®
    console.log('â“ æ’å…¥ç¤ºä¾‹é¢˜ç›®...');
    await query(`
      INSERT IGNORE INTO sl_questions (subject_id, type, content, options, answer, analysis, difficulty, chapter_id, grade, exam_type, status, created_by) VALUES
      (1, 'å•é€‰', 'è®¾é›†åˆA = {1, 2, 3}ï¼ŒB = {2, 3, 4}ï¼Œåˆ™A âˆ© B =', '["A. {1}", "B. {2, 3}", "C. {3, 4}", "D. {1, 2, 3, 4}"]', '["B"]', 'äº¤é›†æ˜¯ä¸¤ä¸ªé›†åˆå…±åŒæ‹¥æœ‰çš„å…ƒç´ ç»„æˆçš„é›†åˆ', 1, 1, 'é«˜ä¸€', 'é€‰æ‹©é¢˜', 'å·²é€šè¿‡', 1),
      (1, 'å•é€‰', 'å‡½æ•°f(x) = xÂ² - 2x + 1çš„æœ€å°å€¼ä¸º', '["A. 0", "B. 1", "C. -1", "D. 2"]', '["A"]', 'é…æ–¹å¾—f(x) = (x-1)Â²ï¼Œæœ€å°å€¼ä¸º0', 2, 2, 'é«˜ä¸€', 'é€‰æ‹©é¢˜', 'å·²é€šè¿‡', 1),
      (1, 'å¡«ç©º', 'è‹¥å‡½æ•°f(x) = 2x + 1ï¼Œåˆ™f(3) = ___', '[]', '[7]', 'f(3) = 2Ã—3 + 1 = 7', 1, 2, 'é«˜ä¸€', 'å¡«ç©ºé¢˜', 'å·²é€šè¿‡', 1)
    `);
    
    console.log('âœ… æ•°æ®åº“ç§å­æ•°æ®å®Œæˆ!');
    process.exit(0);
  } catch (error) {
    console.error('âŒ æ•°æ®åº“ç§å­å¤±è´¥:', error);
    process.exit(1);
  }
}

seed();